---
title: "Analysis of Eden Landing using MEM-PEPRMT 2"
author: "Michael Najarro"
date: "11/13/2020"
output: rmarkdown::github_document
---

```{r}
library(pacman)
p_load(rCTM,
       tidyverse,
       magrittr,
       here,
       R.matlab,
       tictoc,
       beepr)
#lsf.str("package:rCTM")
```


# *Phase 1: MEM*

### *Step 1: Run MEM with Cohorts*


Recent data updates from chamber data can provide a more accurate measure for the Eden Landing Site elevation:

```{r}
elevation<- read.table(file="./Data_sets/EDENLAND082620.txt",sep=",")

x <- elevation %>%
  rename(record=V1,
         S1=V2,
         S2=V3,
         elevation=V4,
         edcv=V5) %>%
  slice(-25) %>%
  summarise(elev = mean(elevation)*100) %>%
  pull(.)
```


The code below implements MEM. Inputs for MEM on Eden Landing can be found at the CCRCN google Drive.

```{r}
startYear=2018
omPackingDensity = 0.82
memCohortExample2<- runMemWithCohorts(startYear=2010,#,2018,
                  endYear=startYear+99,
                  relSeaLevelRiseIni=.09,
                  relSeaLevelRiseTotal=250,
                  initElv=x,
                  meanSeaLevel=98.1,
                  meanSeaLevelDatum=0,#meanSeaLevel[1],
                  meanHighWaterDatum=194.7,
                  meanHighHighWaterDatum = NA,#213.7
                  meanHighHighWaterSpringDatum = NA,
                  suspendedSediment=0.00002,#.00003,
                  lunarNodalAmp=2.5,
                  bMax=.90,#.048,
                  zVegMin=100,
                  zVegMax=350,
                  zVegPeak=180,
                  plantElevationType="orthometric",
                  rootToShoot=2,
                  rootTurnover=0.5,
                  abovegroundTurnover = NA,
                  speciesCode = NA,
                  rootDepthMax=30,
                  shape = "linear",
                  omDecayRate=0.8,
                  recalcitrantFrac=0.35,#0.2,
                  settlingVelocity=0.275,
                  omPackingDensity = 0.82,
                  mineralPackingDensity = 2.43,
                  rootPackingDensity = omPackingDensity,
                  initialCohorts = NA,
                  uplandCohorts = NA, 
                  supertidalCohorts = NA,
                  supertidalSedimentInput = NA)  


slow <- tapply(memCohortExample2$cohorts$slow_OM,
           memCohortExample2$cohorts$year,
           FUN = mean)
slow
fast <- tapply(memCohortExample2$cohorts$fast_OM,
           memCohortExample2$cohorts$year,
           FUN = mean)
fast
resp <-tapply(memCohortExample2$cohorts$respired_OM,
           memCohortExample2$cohorts$year,
           FUN = mean)
resp
```

```{r}
rCTM:::runMemWithCohorts
```

## **Step 2: obtain the sum of slow and fast organic matter pools**

At this point I entirely skip the calculation and downscaling of NPP.

Instead I calculate two important values from MEM to input into the respiration component of PEPRMT. These values will directly correspond to the slow and fast organic matter components of each soil cohort from MEM. The sum of these values approximate the carbon stored within the labile and SOC pools described in the PEPRMT model.

The MEM ouputs for carbon -The slow and fast organic measures - will become inputs for the ecosystem respiration component of PEPRMT. Specifically, they will equate to the sum of slow and fast organic matter that is within one meter below the soil surface at and up to the time of interest (includes all years prior, up to, and include year of interest) in accordinance with the PEPRMT model (see Oikawa 2017). 

Note: the 1 meter depth at this point doesn't matter any more because....?? originally we considered the depth because it simulated soil sampling of core data.

```{r}
# first identify the values of slow and fast om
# that are: 
#   1. within a meter
#   2. within a time interval of the earliest
#       year up to, and including the year of 
#       interest.

#note:
# Within a given year, all rows before the newest
# incremented "age" (n+1th row) are considered past cohorts,
# so only sum the rows within a year of interest!

#2.a) create table cohort up to year 2017.
cohort <- as.data.frame(memCohortExample2$cohorts)
#cores <-- as.data.frame(memCohortExample2$core)

#2.b) create a column that calculates the height
#       of each layer.
lb <- as.vector(cohort$layer_bottom)
lt <- as.vector(cohort$layer_top)

#2.c) extract out cohort data for 2018.
cohort18 <- cohort %>%
  mutate(depth = lb-lt) %>%
   filter(year == 2018)

#2.d) how many layers are exactly one meter
# below the last year of interest (2020) in the depth column?
cohort18 %>%
  summarise(total_depth = sum(depth))
```



# *Phase 2: PEPRMT*

## *Ecosystem Respiration*

### **Step 1: import your data to environment.**

Note that there are two important data sets to load into the environment:

  1. the Eden Landing data for 2018
  
  2. salinity data for eden landing, from 2018-2020 data provided by Patty.

```{r}
#1.a) import the tower data data to environment
EL_2018_master <- readMat(here('./Data_sets/2018_EL_data/EL_2018_master.mat'))

colnames(EL_2018_master$data[[1]]) <- c("daily_DOY_cont",
"daily_DOY_disc",
"daily_TA",
"daily_WT",
"daily_PAR",
"FPAR_1",
"daily_gpp_obs",
"NDVI_placeholder",
"Season_daily_co2_random_error",
"daily_co2_gapfilling_error",
"daily_wetland_age",
"FPAR_2")

EL_obs18 <- EL_2018_master$data[[1]]

EL_obs18 <- EL_obs18 %>%
  as.data.frame(.) %>%
  mutate(daily_DOY_disc = as.integer(daily_DOY_disc),
         daily_DOY_cont = as.integer(daily_DOY_cont))
```



### **Step 2: Prepare the data for peprmt Reco script**

Note that the repiration component of peprmt is producing heterotrophic respiration, not total ecosystem respiration (both hetero and autotroph).

```{r}
# 2.a) substitute the peprmt GPP data with
#       MEM-calculated NPP data; relabel column.
EL_obs18[7] <-  c(rep(0, nrow(EL_obs18)))
```


### **Step 3: Execute peprmt Reco using sum of fast and slow OM of MEM for 2018**

note: the reason the sum of the decayed organic matter is multipled by 10^6 is because the units for each pool's decay rate is at gC/cm^3, while in PEPRMT, the units for theta are in gC/m^3. thus multiplying gC/cm^3 by 100^3cm^3 will produce gC/m^3.


note: there may be an issue within Reco script in calculating S2;
S2[t] <- C2_init + C2in[t]

the units for c2_init and C2in are different and can't be added together: gC/m^3 + gc/m^2 

```{r}
#3.a) sum the slow_om and fast_om values for theta
theta5 <- (mean(cohort18$slow_OM)/mean(cohort18$depth))*1000000
theta6 <- ((mean(cohort18$fast_OM)+mean(cohort18$respired_OM))/mean(cohort18$depth))*1000000

#theta5 <- sum(cohort18$slow_OM)*1000000
#theta6 <- (sum(cohort18$fast_OM)+sum(cohort18$respired_OM))*1000000

#3.b) set up theta values
theta <- c(-1, 0, -1, 0, theta5, theta6)

#3.c) run reco
source('./Peprmt_files/PEPRMT_final_sys_CO2_Reco.R')
PEPRMT_final_sys_CO2_Reco(EL_obs18,
                          theta,
                          wetland_type="coastal")
```



### **Step 3: Plot the peprmt Reco ouputs relative to observed data**

```{r}
#3.a) remove old material first
rm(lb,lt,omPackingDensity,theta5,theta6,theta,PEPRMT_final_sys_CO2_Reco,elevation,cohort,theta,memCohortExample2,a)

#3.b) load reco model results
load(file="./Data_sets/CH4_input.Rdata")

#3.c) pull out obsreved Reco from matlab data and recent EL data #     from Patty + day counter data.
rd <- read_csv(file="./Data_sets/EL_2018_2020_master_9_30_20.csv")

d <- rd %>%
  filter(Year ==2018)%>%
  select(Reco_gC_m2_day) %>%
  pull(.) %>%
  c(0,.)

b<- c(EL_2018_master$daily.er.obs)
days <- c(EL_obs18$daily_DOY_cont)

#3.d) munge the model ouput data to include observed data +
#     day counters.
Reco_output <- Reco_output %>%
  mutate(obs_Reco_matlab = b,
         obs_Reco_recent = d,
         Day_of_year=days) %>%
  rename(MEM_PEPRMT_Reco = Reco_full) %>%
  pivot_longer(c(MEM_PEPRMT_Reco,
                 obs_Reco_matlab,
                 obs_Reco_recent),
               names_to= "Respiration",
               values_to ="Measures")

#3.e) now plot data
ggplot(data = Reco_output) +
  geom_line(mapping=aes(x=Day_of_year, y= Measures, color=Respiration)) +
   labs(x = "Day of year",
        y = expression(paste("Respiration",
                             " ",g,m^{-3})),
                             #" ",g^{3},m^{2},day^{-1})),
        color = "Respiration Source",
        title = "MEM-PEPRMT: Respiration 2018",
        subtitle = "data obtained from Eden Landing") +
   scale_y_continuous(expand=c(0,0)) +
   scale_color_manual(values=c("blue","black","red")) +
   theme(
     panel.grid = element_blank(),
     panel.background = element_rect(fill = "white")
   )
```





## *Methane flux*

```{r}
#clear the environment
rm(b,d,days,rd,Reco_output,cohort18)
```


### **Step 1: Merge the observed data with the outputs of the 2016 respiration component of peprmt**

In order to run the methane component of PEPRMT, the model requires measures of carbon within the labiale and SOC pools, which are identified as columns S1 and S2 of the respiration output.

In previous runs of MEM-PEPERMT, the model ran the methane component using NPP measures from MEM, downscaledto a daily timestep measure in place of GPP.

Here I now test whether NDVI works as a proxy for GPP, by substituting NDVI in place of GPP.

exclude---Note that I remove the columns 'reco_mod' and 'NEE' as they are not needed.

```{r}
# step 1: reload data from Reco model
load(file="./Data_sets/CH4_input.Rdata")

# step 2: merge your Reco ouputs with the filtered 2018 data
#         outputed from MEM.
a<-cbind(EL_obs18, Reco_output)
p<- c(EL_2018_master$daily.gpp.obs)

a <- a %>%
  select(daily_DOY_cont,
         daily_DOY_disc,
         daily_TA,
         daily_WT,
         daily_PAR,
         FPAR_1,
         NDVI_placeholder,
         daily_gpp_obs,
         Season_daily_co2_random_error,
         daily_co2_gapfilling_error,
         daily_wetland_age,
         FPAR_2,
         S1,
         S2) %>%
  rename(ndvi_inplace_gpp=NDVI_placeholder) %>%
  mutate(daily_gpp_obs = p)
```


### **Step 2: Load the salinity inputs into the environment**

I will be using a revised version of the peprmt methane component that incorporates salinity measures. The model requires three additional inputs: Sal_int, Sal_slope, and salinity measures.


update on 11/02:
Here I include a unit conversion of 10^-6 in order to get the units into micromoles per meter cubed
```{r}
#2.a) load in to the 2018-2020 EL data to obtain salinity for'18
salinity <- read.csv(file=paste("./Data_sets/EL_2018_2020_master_9_30_20.csv",sep=""))

salt <- salinity %>%
  filter(Year == 2018) %>%
  select(Salinity_daily_ave_ppt) %>%
  pull() %>%
  c(0,.)

a <- a %>%
  mutate(Sal = salt) %>%
  select(daily_DOY_cont:FPAR_2, Sal, S1, S2) %>%
  mutate(S1 = S1, #*.000001,#.0000001,
         S2 = S2 #*.000001#.0000001
         )
```


### **Step 3: setup other inputs to Ch4 script**

```{r}
# 3.a) create your model inputs
theta= c(-10, 5, -10, 5, 10, 5)
#theta= c(-9, 2, -9, 2, 6, 2)
#theta= c(5, 1, 5, 1, 5, 1)
Sal_int <- 0.215850539
Sal_slope <- -0.008947612
```


### **Step 4: Implement the latest version of the methane component of MEM-PEP one time**

Please the see the notes within the file PEPRMT_final_sys_gammaCH4_V4.R for details on model modifications; this is the latest version of the methane component of PEPRMT.

```{r}
#4.a) load the new methane flux script
source('./Peprmt_files/PEPRMT_Final_sys_CH4_V5.R')
#source('./Peprmt_files/PEPRMT_Final_sys_CH4gamma_V4.R')

#21.b) execute your model given the inputs
tic()
CH4_mod_RR <- CH4_daily_step(theta,
                             a,
                             Sal_slope,
                             Sal_int,
                             x = 1,
                             wetland_type = 2)
toc()
beep(1)
```


do a quick plot of the ch4 outputs below

```{r}
test_graph <- CH4_mod_RR
x<- EL_2018_master$daily.ch4.obs

test_graph %>%
    mutate(observed = x,
           sum_of_ms = M1 + M2,
           roxi =r_oxi,
           ch4water = ch4_water) %>%
  pivot_longer(c(avg_Pulse_Emission_Total,
                 M1,
                 M2,
                 hydro_flux,
                 Plant_flux,#,
                 observed,
                 sum_of_ms,
                 roxi,
                 ch4water),
               names_to='outputs',
               values_to='measures'
               ) %>%
  ggplot(data=., mapping = aes(x=index, y=measures, color= outputs)) +
  geom_line()



#test_graph %>% 
#  pivot_longer(c(avg_Pulse_Emission_Total,
#                 M1,
#                 M2,
#                 hydro_flux,
#                 Plant_flux),
#               names_to='outputs',
#               values_to='measures'
#               ) %>%
#  ggplot(data=., mapping = aes(x=index, y=measures, color= outputs)) +
#  geom_line()
```





### **Step 5: Plot model outputs alongside obsreved data**

```{r}
#5.a) clear environ
rm(Reco_output,avg_ch4_outputs,salinity,p,Sal_int,Sal_slope,theta,salt)

#5.b) merge your data sets:
#w = matlab observed ch4
#a = matlab data used to extract day counters
#Ch4_mod_RR =peprmt ch4 model output
# rd&d = recent Eden landing tower data from 2018-2020;contains
#     methane tower data.

rd <- read_csv(file="./Data_sets/EL_2018_2020_master_9_30_20.csv")
d <- rd %>%
  filter(Year ==2018)%>%
  select(CH4_gC_m2_day) %>%
  pull(.) %>%
  c(0,.)

w <- c(EL_2018_master$daily.ch4.obs)

data_CH4_mod_EL <- cbind(a,CH4_mod_RR,w,d) %>%
  select(daily_DOY_cont,
         S1,
         S2,
         avg_Pulse_Emission_Total,
         w,
         d) %>%
  rename( obs_ch4_matlab = w,
          obs_ch4_recent = d)

#data_CH4_mod_EL <- data_CH4_mod_EL[,c(1,14,15,17,18)]
#data_CH4_mod_EL<-rename(data_CH4_mod_EL, obs_ch4 = w)

#5.c) unit change on the microsite column
# multiplied by 1000 to get from micro to nano moles.
data_CH4_mod_EL <- data_CH4_mod_EL %>%
  mutate(avg_Pulse_Emission_Total = avg_Pulse_Emission_Total) %>%
  pivot_longer(c(obs_ch4_matlab,
                 avg_Pulse_Emission_Total,
                 obs_ch4_recent),
               names_to ="methane_flux",
               values_to = "CH4_measure")

#5.d) plot
 ggplot(data = data_CH4_mod_EL) +
   geom_line(aes(x= daily_DOY_cont,
                 y= CH4_measure,
                 color=methane_flux)) +
   labs(x = "Day of year",
        y = expression(paste("CH4 exchange"," ","grams C"," ", m^{-2},s^{-1})),
        color = expression(paste("methane"," ","flux")),
        title = "MEM-PEPRMT: Methane Emissions 2018",
        subtitle = "data obtained from Eden Landing") +
   scale_y_continuous(expand=c(0,0)) +
   scale_color_manual(values=c("blue","black","grey")) +
   theme(
     panel.grid = element_blank(),
     panel.background = element_rect(fill = "white")
   )
```
